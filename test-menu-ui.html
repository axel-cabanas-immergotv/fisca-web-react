<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Builder UI Test</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        /* Menu Builder Styles */
        .menu-builder-container {
            min-height: 300px;
        }

        .menu-item {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .menu-item:hover {
            border-color: #007cba;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .menu-item-content {
            display: flex;
            align-items: center;
            padding: 12px;
            gap: 12px;
        }

        .menu-item-handle {
            color: #666;
            cursor: grab;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }

        .menu-item-handle:hover {
            opacity: 1;
            color: #007cba;
        }

        .menu-item-handle:active {
            cursor: grabbing;
        }

        .menu-item-info {
            flex: 1;
            min-width: 0;
        }

        .menu-item-title {
            font-weight: 500;
            color: #23282d;
            margin-bottom: 2px;
            word-break: break-word;
        }

        .menu-item-url {
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }

        .menu-item-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        /* Sub-items styling */
        .menu-sub-items {
            padding-left: 32px;
            position: relative;
        }

        .menu-sub-items::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ddd;
        }

        .menu-sub-item {
            background: #f9f9f9;
            border-left: 3px solid #007cba;
        }

        .menu-sub-item:hover {
            background: #fff;
        }

        /* Sub-sub-items styling */
        .menu-sub-sub-items {
            padding-left: 24px;
        }

        .menu-sub-sub-item {
            background: #f5f5f5;
            border-left: 3px solid #46b450;
        }

        .menu-sub-sub-item:hover {
            background: #f9f9f9;
        }

        /* Sortable states */
        .sortable-ghost {
            opacity: 0.4;
            background: #e3f2fd !important;
            border: 2px dashed #007cba !important;
        }

        .sortable-ghost .menu-item-content {
            opacity: 0.6;
        }

        /* Empty state styling */
        .menu-builder-container .text-center {
            background: #f9f9f9;
            border: 2px dashed #ddd;
            border-radius: 8px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4" x-data="menuTest()">
        <div class="row">
            <div class="col-12">
                <h1>Menu Builder UI Test</h1>
                <p class="text-muted">Testing the menu builder interface with drag and drop functionality</p>
            </div>
        </div>

        <!-- Menu Basic Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Menu Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="menu-title" class="form-label">Menu Title</label>
                            <input type="text" class="form-control" id="menu-title" 
                                   x-model="currentMenu.title" placeholder="Enter menu title">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="menu-status" class="form-label">Status</label>
                            <select class="form-select" id="menu-status" x-model="currentMenu.status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Items Builder -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Menu Structure</h5>
                <button class="btn btn-sm btn-primary" @click="addMenuItem()">
                    <i class="fas fa-plus me-1"></i>Add Item
                </button>
            </div>
            <div class="card-body">
                <div class="menu-builder-container">
                    <!-- Empty state -->
                    <div x-show="!currentMenu.links || currentMenu.links.length === 0" class="text-center py-5">
                        <i class="fas fa-bars fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No menu items yet</h5>
                        <p class="text-muted">Start building your menu by adding items</p>
                        <button class="btn btn-primary" @click="addMenuItem()">
                            <i class="fas fa-plus me-1"></i>Add First Item
                        </button>
                    </div>

                    <!-- Menu items list -->
                    <div id="menu-items-sortable" x-show="currentMenu.links && currentMenu.links.length > 0">
                        <template x-for="(item, index) in currentMenu.links" :key="item.id">
                            <div class="menu-item" :data-id="item.id">
                                <div class="menu-item-content">
                                    <div class="menu-item-handle">
                                        <i class="fas fa-grip-vertical"></i>
                                    </div>
                                    <div class="menu-item-info flex-grow-1">
                                        <div class="menu-item-title" x-text="item.title || 'Untitled'"></div>
                                        <div class="menu-item-url text-muted" x-text="item.url || 'No URL'"></div>
                                    </div>
                                    <div class="menu-item-actions">
                                        <button class="btn btn-sm btn-outline-primary me-1" 
                                                @click="editMenuItem(index)"
                                                title="Edit Item">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success me-1" 
                                                @click="addSubMenuItem(index)"
                                                title="Add Sub Item">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                @click="removeMenuItem(index)"
                                                title="Remove Item">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Sub-items -->
                                <div x-show="item.children && item.children.length > 0" class="menu-sub-items">
                                    <div class="sub-items-sortable" :data-parent="item.id">
                                        <template x-for="(subItem, subIndex) in item.children" :key="subItem.id">
                                            <div class="menu-item menu-sub-item" :data-id="subItem.id">
                                                <div class="menu-item-content">
                                                    <div class="menu-item-handle">
                                                        <i class="fas fa-grip-vertical"></i>
                                                    </div>
                                                    <div class="menu-item-info flex-grow-1">
                                                        <div class="menu-item-title" x-text="subItem.title || 'Untitled'"></div>
                                                        <div class="menu-item-url text-muted" x-text="subItem.url || 'No URL'"></div>
                                                    </div>
                                                    <div class="menu-item-actions">
                                                        <button class="btn btn-sm btn-outline-primary me-1" 
                                                                @click="editSubMenuItem(index, subIndex)"
                                                                title="Edit Sub Item">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success me-1" 
                                                                @click="addSubSubMenuItem(index, subIndex)"
                                                                title="Add Sub-Sub Item">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" 
                                                                @click="removeSubMenuItem(index, subIndex)"
                                                                title="Remove Sub Item">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Sub-sub-items -->
                                                <div x-show="subItem.children && subItem.children.length > 0" class="menu-sub-items menu-sub-sub-items">
                                                    <div class="sub-sub-items-sortable" :data-parent="subItem.id">
                                                        <template x-for="(subSubItem, subSubIndex) in subItem.children" :key="subSubItem.id">
                                                            <div class="menu-item menu-sub-sub-item" :data-id="subSubItem.id">
                                                                <div class="menu-item-content">
                                                                    <div class="menu-item-handle">
                                                                        <i class="fas fa-grip-vertical"></i>
                                                                    </div>
                                                                    <div class="menu-item-info flex-grow-1">
                                                                        <div class="menu-item-title" x-text="subSubItem.title || 'Untitled'"></div>
                                                                        <div class="menu-item-url text-muted" x-text="subSubItem.url || 'No URL'"></div>
                                                                    </div>
                                                                    <div class="menu-item-actions">
                                                                        <button class="btn btn-sm btn-outline-primary me-1" 
                                                                                @click="editSubSubMenuItem(index, subIndex, subSubIndex)"
                                                                                title="Edit Sub-Sub Item">
                                                                            <i class="fas fa-edit"></i>
                                                                        </button>
                                                                        <button class="btn btn-sm btn-outline-danger" 
                                                                                @click="removeSubSubMenuItem(index, subIndex, subSubIndex)"
                                                                                title="Remove Sub-Sub Item">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug info -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Debug: Current Menu Structure</h5>
            </div>
            <div class="card-body">
                <pre x-text="JSON.stringify(currentMenu.links, null, 2)" class="bg-light p-3"></pre>
            </div>
        </div>

        <!-- Menu Item Edit Modal -->
        <div class="modal fade" id="menuItemModal" tabindex="-1" aria-labelledby="menuItemModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="menuItemModalLabel">Edit Menu Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="menu-item-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="item-title" class="form-label">Title</label>
                                        <input type="text" class="form-control" id="item-title" 
                                               x-model="editingItem.title" placeholder="Menu item title">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="item-url" class="form-label">URL</label>
                                        <input type="text" class="form-control" id="item-url" 
                                               x-model="editingItem.url" placeholder="https://example.com">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="item-target" class="form-label">Target</label>
                                        <select class="form-select" id="item-target" x-model="editingItem.target">
                                            <option value="_self">Same Window</option>
                                            <option value="_blank">New Window</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="item-icon" class="form-label">Icon (Font Awesome class)</label>
                                        <input type="text" class="form-control" id="item-icon" 
                                               x-model="editingItem.icon" placeholder="fas fa-home">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="item-description" class="form-label">Description</label>
                                <textarea class="form-control" id="item-description" rows="3" 
                                          x-model="editingItem.description" placeholder="Optional description"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" @click="saveMenuItem()">Save Item</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function menuTest() {
            return {
                currentMenu: {
                    title: 'Test Menu',
                    platform: 'Web',
                    links: [
                        {
                            id: 'item_1',
                            title: 'Home',
                            url: '/',
                            target: '_self',
                            icon: 'fas fa-home',
                            description: 'Homepage link',
                            children: []
                        },
                        {
                            id: 'item_2',
                            title: 'About',
                            url: '/about',
                            target: '_self',
                            icon: 'fas fa-info',
                            description: 'About page',
                            children: [
                                {
                                    id: 'item_2_1',
                                    title: 'Our Team',
                                    url: '/about/team',
                                    target: '_self',
                                    icon: 'fas fa-users',
                                    description: 'Team page',
                                    children: []
                                }
                            ]
                        }
                    ],
                    status: 'active',
                    sort_order: 0
                },
                editingItem: {
                    title: '',
                    url: '',
                    target: '_self',
                    icon: '',
                    description: ''
                },
                editingIndex: null,
                editingSubIndex: null,
                editingSubSubIndex: null,
                editingMode: 'new',
                sortableInstances: [],

                // Initialize sortables when component mounts
                init() {
                    this.$nextTick(() => {
                        this.initializeSortables();
                    });
                },

                // Add all the same methods from menus.js
                addMenuItem() {
                    this.editingItem = {
                        id: this.generateId(),
                        title: '',
                        url: '',
                        target: '_self',
                        icon: '',
                        description: '',
                        children: []
                    };
                    this.editingMode = 'new';
                    this.editingIndex = null;
                    this.editingSubIndex = null;
                    this.editingSubSubIndex = null;
                    this.showMenuItemModal();
                },

                editMenuItem(index) {
                    this.editingItem = { ...this.currentMenu.links[index] };
                    this.editingMode = 'edit';
                    this.editingIndex = index;
                    this.editingSubIndex = null;
                    this.editingSubSubIndex = null;
                    this.showMenuItemModal();
                },

                addSubMenuItem(parentIndex) {
                    this.editingItem = {
                        id: this.generateId(),
                        title: '',
                        url: '',
                        target: '_self',
                        icon: '',
                        description: '',
                        children: []
                    };
                    this.editingMode = 'sub';
                    this.editingIndex = parentIndex;
                    this.editingSubIndex = null;
                    this.editingSubSubIndex = null;
                    this.showMenuItemModal();
                },

                editSubMenuItem(parentIndex, subIndex) {
                    this.editingItem = { ...this.currentMenu.links[parentIndex].children[subIndex] };
                    this.editingMode = 'edit-sub';
                    this.editingIndex = parentIndex;
                    this.editingSubIndex = subIndex;
                    this.editingSubSubIndex = null;
                    this.showMenuItemModal();
                },

                addSubSubMenuItem(parentIndex, subIndex) {
                    this.editingItem = {
                        id: this.generateId(),
                        title: '',
                        url: '',
                        target: '_self',
                        icon: '',
                        description: ''
                    };
                    this.editingMode = 'subsub';
                    this.editingIndex = parentIndex;
                    this.editingSubIndex = subIndex;
                    this.editingSubSubIndex = null;
                    this.showMenuItemModal();
                },

                editSubSubMenuItem(parentIndex, subIndex, subSubIndex) {
                    this.editingItem = { ...this.currentMenu.links[parentIndex].children[subIndex].children[subSubIndex] };
                    this.editingMode = 'edit-subsub';
                    this.editingIndex = parentIndex;
                    this.editingSubIndex = subIndex;
                    this.editingSubSubIndex = subSubIndex;
                    this.showMenuItemModal();
                },

                saveMenuItem() {
                    if (!this.editingItem.title.trim()) {
                        alert('Please enter a title for the menu item');
                        return;
                    }

                    const item = { ...this.editingItem };

                    switch (this.editingMode) {
                        case 'new':
                            this.currentMenu.links.push(item);
                            break;
                        case 'edit':
                            this.currentMenu.links[this.editingIndex] = item;
                            break;
                        case 'sub':
                            if (!this.currentMenu.links[this.editingIndex].children) {
                                this.currentMenu.links[this.editingIndex].children = [];
                            }
                            this.currentMenu.links[this.editingIndex].children.push(item);
                            break;
                        case 'edit-sub':
                            this.currentMenu.links[this.editingIndex].children[this.editingSubIndex] = item;
                            break;
                        case 'subsub':
                            if (!this.currentMenu.links[this.editingIndex].children[this.editingSubIndex].children) {
                                this.currentMenu.links[this.editingIndex].children[this.editingSubIndex].children = [];
                            }
                            this.currentMenu.links[this.editingIndex].children[this.editingSubIndex].children.push(item);
                            break;
                        case 'edit-subsub':
                            this.currentMenu.links[this.editingIndex].children[this.editingSubIndex].children[this.editingSubSubIndex] = item;
                            break;
                    }

                    this.hideMenuItemModal();
                    
                    this.$nextTick(() => {
                        this.initializeSortables();
                    });
                },

                removeMenuItem(index) {
                    if (confirm('Are you sure you want to remove this menu item?')) {
                        this.currentMenu.links.splice(index, 1);
                        this.$nextTick(() => {
                            this.initializeSortables();
                        });
                    }
                },

                removeSubMenuItem(parentIndex, subIndex) {
                    if (confirm('Are you sure you want to remove this sub menu item?')) {
                        this.currentMenu.links[parentIndex].children.splice(subIndex, 1);
                        this.$nextTick(() => {
                            this.initializeSortables();
                        });
                    }
                },

                removeSubSubMenuItem(parentIndex, subIndex, subSubIndex) {
                    if (confirm('Are you sure you want to remove this sub-sub menu item?')) {
                        this.currentMenu.links[parentIndex].children[subIndex].children.splice(subSubIndex, 1);
                        this.$nextTick(() => {
                            this.initializeSortables();
                        });
                    }
                },

                initializeSortables() {
                    this.destroySortables();

                    // Main items sortable
                    const mainSortable = document.getElementById('menu-items-sortable');
                    if (mainSortable) {
                        const sortable = Sortable.create(mainSortable, {
                            handle: '.menu-item-handle',
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            onEnd: (evt) => {
                                this.moveMenuItem(evt.oldIndex, evt.newIndex);
                            }
                        });
                        this.sortableInstances.push(sortable);
                    }

                    // Sub items sortables
                    document.querySelectorAll('.sub-items-sortable').forEach((container) => {
                        const parentId = container.getAttribute('data-parent');
                        const sortable = Sortable.create(container, {
                            handle: '.menu-item-handle',
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            onEnd: (evt) => {
                                const parentIndex = this.findItemIndexById(parentId);
                                if (parentIndex !== -1) {
                                    this.moveSubMenuItem(parentIndex, evt.oldIndex, evt.newIndex);
                                }
                            }
                        });
                        this.sortableInstances.push(sortable);
                    });

                    // Sub-sub items sortables
                    document.querySelectorAll('.sub-sub-items-sortable').forEach((container) => {
                        const parentId = container.getAttribute('data-parent');
                        const sortable = Sortable.create(container, {
                            handle: '.menu-item-handle',
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            onEnd: (evt) => {
                                const indices = this.findSubItemIndicesById(parentId);
                                if (indices.parentIndex !== -1 && indices.subIndex !== -1) {
                                    this.moveSubSubMenuItem(indices.parentIndex, indices.subIndex, evt.oldIndex, evt.newIndex);
                                }
                            }
                        });
                        this.sortableInstances.push(sortable);
                    });
                },

                destroySortables() {
                    this.sortableInstances.forEach(instance => {
                        if (instance && instance.destroy) {
                            instance.destroy();
                        }
                    });
                    this.sortableInstances = [];
                },

                moveMenuItem(oldIndex, newIndex) {
                    const item = this.currentMenu.links.splice(oldIndex, 1)[0];
                    this.currentMenu.links.splice(newIndex, 0, item);
                },

                moveSubMenuItem(parentIndex, oldIndex, newIndex) {
                    const item = this.currentMenu.links[parentIndex].children.splice(oldIndex, 1)[0];
                    this.currentMenu.links[parentIndex].children.splice(newIndex, 0, item);
                },

                moveSubSubMenuItem(parentIndex, subIndex, oldIndex, newIndex) {
                    const item = this.currentMenu.links[parentIndex].children[subIndex].children.splice(oldIndex, 1)[0];
                    this.currentMenu.links[parentIndex].children[subIndex].children.splice(newIndex, 0, item);
                },

                generateId() {
                    return 'item_' + Math.random().toString(36).substr(2, 9);
                },

                findItemIndexById(id) {
                    return this.currentMenu.links.findIndex(item => item.id === id);
                },

                findSubItemIndicesById(id) {
                    for (let i = 0; i < this.currentMenu.links.length; i++) {
                        if (this.currentMenu.links[i].children) {
                            for (let j = 0; j < this.currentMenu.links[i].children.length; j++) {
                                if (this.currentMenu.links[i].children[j].id === id) {
                                    return { parentIndex: i, subIndex: j };
                                }
                            }
                        }
                    }
                    return { parentIndex: -1, subIndex: -1 };
                },

                showMenuItemModal() {
                    const modal = new bootstrap.Modal(document.getElementById('menuItemModal'));
                    modal.show();
                },

                hideMenuItemModal() {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('menuItemModal'));
                    if (modal) {
                        modal.hide();
                    }
                }
            };
        }
    </script>
</body>
</html> 